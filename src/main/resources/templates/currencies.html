<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/heading :: heading">


</head>
<body>
<a th:href="${link}">Sign in to coinbase</a>


<main class="mdl-layout__content">

    <!--<div>

        <h1 th:text="${usd}" style="color:green;"></h1>
        <h1 th:text="${eur}" style="color:blue;"></h1>
        <h1 th:text="${gbp}"></h1>




    </div>-->

    <div class="custom-jumbotron manteka" th:each="list:${data}">
        <div style="background-color:pink;width:50%">
            <div style="width:100%;background-color:brown;"><h1 th:text="${list.key}"></h1></div>
            <div style="width:100%;background-color:purple;"><p th:id="|date-${list.key}|" th:text="|As of ${list.date}|"></p></div>
        </div>
        <div style="background-color:green;width:50%">
            <table th:id="|key-${list.key}|">
                <tr th:each="item:${list.values}" >
                    <td><p th:text="${item.quote}" th:id="|quote-${item.pair}|" style="color:red;"></p></td>
                    <td><p th:text="${item.rate}" th:id="|rate-${item.pair}|" style="color:blue;"></p></td>
                    <td><p th:text="0" th:id="|diff-${item.pair}|" style="color:blue;"></p></td>
                </tr>

            </table>
        </div>

        <table>
        <tr>
            <td></td>



        </tr>

        </table>


    </div>




    <div class="mdl-grid">
        <div class="mdl-cell mdl-cell--12-col mdl-cell--8-col-tablet mdl-cell--4-col-phone">
            </div>
    </div>

</main>
</body>
<style>



    .custom-jumbotron{
        min-width:360px;
        width:90%;
        display: inline-flex;
        border-style:solid;
        align-items: center;
        padding: 5px;
        margin-bottom: 5px;

    }

    .custom-card{
        min-width:360px;
        width:100%;
        border-style:solid;

    }

</style>

<script type="text/javascript">
    if (!!window.EventSource) {
        console.log("Event source available");

        var source = new EventSource('/sse/currencies');

        var last_value_object = {};

        source.addEventListener('message', function(e) {
            console.log("this was from message");
            console.log(e.data);
            var d = JSON.parse(e.data);
            console.dir(d);

            for(var i=0;i<d.length;i++){
                console.dir(d[i]);
                var key = d[i]["key"];
                var values = d[i]["values"];

                var date_id="date-"+key;

                for(var q=0;q<values.length;q++){
                    var pair = values[q]["pair"];
                    var rate_id="rate-"+pair;
                    var diff_id="diff-"+pair;

                    var last_value = (typeof last_value_object[rate_id] != "undefined") ? last_value_object[rate_id]:0;
                    var difference = parseFloat(values[q]["rate"]) - parseFloat(last_value);

                    document.getElementById(rate_id).innerText=values[q]["rate"];
                    document.getElementById(diff_id).innerText=difference;

                    if(difference > 0){
                        document.getElementById(rate_id).style.backgroundColor="yellow";
                    }else if(difference < 0){
                        document.getElementById(rate_id).style.backgroundColor="red";
                    }
                    else{
                        document.getElementById(rate_id).style.backgroundColor="grey";
                    }
                    last_value_object[rate_id] = values[q]["rate"];
                }
                document.getElementById(date_id).innerText=d[i]["date"];
            }
            console.log("this was from message");

        });

        source.addEventListener('currencies', function(e) {
            console.log("this was from currencies");
            console.log(e.data);
            console.log("this was from currencies");

        });

        source.addEventListener('open', function(e) {
            console.log("Connection was opened.");
        }, false);

        source.addEventListener('error', function(e) {
            if (e.readyState == EventSource.CLOSED) {
                console.log("Connection was closed.");
            } else {
                console.log(e.readyState);
            }
        }, false);
    } else {
        console.log("No SSE available");
    }

</script>
</html>
